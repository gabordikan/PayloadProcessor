var eventData = JSON.parse(getTextIfNullReturnEmptyJson('event_data', null));
var requestData = bindObject('REQUEST_DATA');
var attachmentPdf = getAttachmentDataByAttachmentMnemonicAndBodySite('event_pdf', requestData.bodySiteSnomed);

if (typeof requestData.study_instance_uid != "undefined") {
    requestData.biometryId = getBiometryEventId(requestData.study_instance_uid);
} else {
    throw new Error("Study instance UID is required to get biometry ID");
}

requestData.isDuplicateAttachmentForEvent = isDuplicateAttachmentForEvent(requestData.biometryId, attachmentPdf.getHashCode());

if (!requestData.isDuplicateAttachmentForEvent || typeof requestData.isDuplicateAttachmentForEvent == "undefined") {
    requestData.eventId = requestData.biometryId;

    eventData['$$_SaveSet[1]_$$'].forEach(function(data) {
        var dataSet = data.$$_DataSet_$$;

        if (dataSet == "et_ophgeneric_attachment") {
            var attachmentRow = data.$$_ROW_$$[0];
            attachmentRow.event_id = requestData.biometryId;
        }
    });

    var eventData = createEvent(JSON.stringify(eventData));

    putText(
        'event_data',
        eventData,
        'NONE',
        null, 'application/json');
    addRoutine('link_biometry_attachment_with_event');
} else {
    addRoutine('event_not_updated_duplicate_attachment');
}